<?php

namespace App\Http\Controllers\Api\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Demande;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;

class DemandesController extends Controller
{
    /**
     * Obtenir toutes les demandes avec filtres et pagination
     */
    public function index(Request $request)
    {
        try {
            $query = Demande::with(['etudiant', 'administrateur']);

            // Filtrage par statut
            if ($request->has('statut') && $request->statut !== 'tous') {
                $statutMapping = [
                    'en_attente' => 'En attente',
                    'acceptee' => 'Valid√©e',
                    'refusee' => 'Refus√©e'
                ];
                $query->where('statut', $statutMapping[$request->statut] ?? $request->statut);
            }

            // Filtrage par type de document
            if ($request->has('typeDoc') && $request->typeDoc !== 'toutes') {
                $typeMapping = [
                    'attestation_scolarite' => 'AttestationScolarite',
                    'attestation_reussite' => 'AttestationReussite',
                    'releve_notes' => 'ReleveNote',
                    'convention_stage' => 'ConventionStage'
                ];
                $query->where('typeDoc', $typeMapping[$request->typeDoc] ?? $request->typeDoc);
            }

            // Recherche par nom, pr√©nom ou num√©ro apog√©e
            if ($request->has('search') && $request->search) {
                $search = $request->search;
                $query->whereHas('etudiant', function ($q) use ($search) {
                    $q->where('nom', 'like', "%{$search}%")
                      ->orWhere('prenom', 'like', "%{$search}%")
                      ->orWhere('numApogee', 'like', "%{$search}%");
                });
            }

            // Pagination
            $page = $request->get('page', 1);
            $limit = $request->get('limit', 20);

            $demandes = $query->orderBy('datesoumission', 'desc')
                ->skip(($page - 1) * $limit)
                ->take($limit)
                ->get()
                ->map(function ($demande) {
                    // R√©cup√©rer les d√©tails sp√©cifiques selon le type
                    $details = $this->getDemandeDetails($demande);

                    return [
                        'id' => 'DEM-' . str_pad($demande->idDemande, 3, '0', STR_PAD_LEFT),
                        'idDemande' => $demande->idDemande,
                        'type' => $this->mapTypeToFrontend($demande->typeDoc),
                        'typeLabel' => $this->getTypeLabel($demande->typeDoc),
                        'statut' => $this->mapStatutToFrontend($demande->statut),
                        'etudiant' => $demande->etudiant ? [
                            'nom' => $demande->etudiant->nom . ' ' . $demande->etudiant->prenom,
                            'apogee' => $demande->etudiant->numApogee,
                            'email' => $demande->etudiant->emailInstitu,
                        ] : null,
                        'date' => $demande->datesoumission->format('d/m/Y'),
                        'details' => $details,
                    ];
                });

            $total = $query->count();

            return response()->json([
                'success' => true,
                'data' => [
                    'demandes' => $demandes,
                    'pagination' => [
                        'page' => $page,
                        'limit' => $limit,
                        'total' => $total,
                        'pages' => ceil($total / $limit)
                    ]
                ]
            ])
            ->header('Access-Control-Allow-Origin', '*')
            ->header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
            ->header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la r√©cup√©ration des demandes: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Valider une demande
     */
    public function valider(Request $request, $idDemande)
    {
        try {
            $demande = Demande::findOrFail($idDemande);

            if ($demande->statut !== 'En attente') {
                return response()->json([
                    'success' => false,
                    'message' => 'Cette demande ne peut pas √™tre valid√©e'
                ], 400);
            }

            $demande->update([
                'statut' => 'Valid√©e',
                'date_traitement' => now(),
                'idAdmin' => $request->user()->id ?? 1 // TODO: g√©rer l'authentification admin
            ]);

            // TODO: Envoyer email √† l'√©tudiant

            return response()->json([
                'success' => true,
                'message' => 'Demande valid√©e avec succ√®s'
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la validation: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Refuser une demande
     */
    public function refuser(Request $request, $idDemande)
    {
        try {
            $request->validate([
                'motif_refus' => 'required|string|max:1000'
            ]);

            $demande = Demande::findOrFail($idDemande);

            if ($demande->statut !== 'En attente') {
                return response()->json([
                    'success' => false,
                    'message' => 'Cette demande ne peut pas √™tre refus√©e'
                ], 400);
            }

            $demande->update([
                'statut' => 'Refus√©e',
                'motif_refus' => $request->motif_refus,
                'date_traitement' => now(),
                'idAdmin' => $request->user()->id ?? 1 // TODO: g√©rer l'authentification admin
            ]);

            // TODO: Envoyer email √† l'√©tudiant

            return response()->json([
                'success' => true,
                'message' => 'Demande refus√©e avec succ√®s'
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors du refus: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Pr√©visualiser un PDF de la demande (placeholder minimal)
     */
    public function preview($idDemande)
    {
        try {
            // Charger relations suppos√©es par type (ajustez les relations selon vos mod√®les)
            $demande = Demande::with(['etudiant', 'attestationscolarite', 'attestationreussite', 'relevenote', 'conventionstage'])
                ->findOrFail($idDemande);

            $typeLabel = $this->getTypeLabel($demande->typeDoc);
            $etudiantNom = $demande->etudiant ? ($demande->etudiant->nom . ' ' . $demande->etudiant->prenom) : 'Etudiant inconnu';
            $apogee = $demande->etudiant->numApogee ?? 'N/A';
            $email = $demande->etudiant->emailInstitu ?? 'N/A';
            $now = now()->format('d/m/Y H:i');

            // Construire des lignes selon le type
            $lines = [];
            $lines[] = "Previsualisation: {$typeLabel}";
            $lines[] = "Demande #{$demande->idDemande}";
            $lines[] = "Etudiant: {$etudiantNom}";
            $lines[] = "Apogee: {$apogee}";
            $lines[] = "Email: {$email}";
            $lines[] = "Date generation: {$now}";

            switch ($demande->typeDoc) {
                case 'ReleveNote':
                    $r = $demande->relevenote;
                    if ($r) {
                        $lines[] = "Type: Releve de notes";
                        $lines[] = "Semestre: " . ($r->semestre ?? 'N/A');
                        $lines[] = "Annee universitaire: " . ($r->anneeUniversitaire ?? 'N/A');
                        // Ajoutez d'autres champs si existants (modules, moyennes, etc.)
                    }
                    break;
                case 'AttestationScolarite':
                    $a = $demande->attestationscolarite;
                    if ($a) {
                        $lines[] = "Type: Attestation de scolarite";
                        $lines[] = "Filiere: " . ($a->filiere ?? 'N/A');
                        $lines[] = "Nombre d'exemplaires: " . ($a->nombreExemplaires ?? '1');
                    }
                    break;
                case 'AttestationReussite':
                    $a = $demande->attestationreussite;
                    if ($a) {
                        $lines[] = "Type: Attestation de reussite";
                        $lines[] = "Filiere: " . ($a->filiere ?? 'N/A');
                        $lines[] = "Annee universitaire: " . ($a->anneeUniversitaire ?? 'N/A');
                    }
                    break;
                case 'ConventionStage':
                    $c = $demande->conventionstage;
                    if ($c) {
                        $lines[] = "Type: Convention de stage";
                        $lines[] = "Entreprise: " . ($c->entreprise ?? 'N/A');
                        $periode = ($c->dateDebut && $c->dateFin) ? $c->dateDebut->format('d/m/Y') . ' -> ' . $c->dateFin->format('d/m/Y') : 'N/A';
                        $lines[] = "Periode: " . $periode;
                        $lines[] = "Sujet: " . ($c->sujet ?? 'N/A');
                    }
                    break;
            }

            // Sanitize ASCII (remplacer accents) et √©chapper PDF
            $lines = array_map(function($l){
                $l = iconv('UTF-8', 'ASCII//TRANSLIT//IGNORE', $l);
                $l = str_replace(['\\', '(', ')'], ['\\\\', '\\(', '\\)'], $l);
                return $l;
            }, $lines);

            // G√©n√©rer un PDF minimal multi-lignes
            $pdf = "%PDF-1.4\n";
            $pdf .= "1 0 obj <</Type /Catalog /Pages 2 0 R>> endobj\n";
            $pdf .= "2 0 obj <</Type /Pages /Kids [3 0 R] /Count 1>> endobj\n";
            $pdf .= "3 0 obj <</Type /Page /Parent 2 0 R /MediaBox [0 0 595 842] /Contents 4 0 R /Resources <</Font <</F1 5 0 R>>>>>> endobj\n";
            $y = 780; $leading = 18; $content = "BT /F1 12 Tf 50 $y Td ";
            $first = true;
            foreach ($lines as $line) {
                if (!$first) { $content .= "0 -$leading Td "; }
                $content .= "(" . $line . ") Tj ";
                $first = false;
            }
            $content .= "ET";
            $pdf .= "4 0 obj <</Length " . strlen($content) . ">> stream\n{$content}\nendstream endobj\n";
            $pdf .= "5 0 obj <</Type /Font /Subtype /Type1 /BaseFont /Helvetica>> endobj\n";
            $pdf .= "xref\n0 6\n0000000000 65535 f \ntrailer <</Size 6/Root 1 0 R>>\nstartxref\n0\n%%EOF";

            return response($pdf, 200)
                ->header('Content-Type', 'application/pdf')
                ->header('Access-Control-Allow-Origin', '*');
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Impossible de g√©n√©rer la pr√©visualisation: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Obtenir les d√©tails sp√©cifiques d'une demande
     */
    private function getDemandeDetails($demande)
    {
        switch ($demande->typeDoc) {
            case 'AttestationScolarite':
                $detail = $demande->attestationscolarite;
                return $detail ? [
                    'filiere' => $detail->filiere ?? 'N/A',
                    'nombreExemplaires' => $detail->nombreExemplaires ?? 1,
                ] : [];

            case 'AttestationReussite':
                $detail = $demande->attestationreussite;
                return $detail ? [
                    'filiere' => $detail->filiere ?? 'N/A',
                    'anneeUniversitaire' => $detail->anneeUniversitaire ?? 'N/A',
                ] : [];

            case 'ReleveNote':
                $detail = $demande->relevenote;
                return $detail ? [
                    'semestre' => $detail->semestre ?? 'N/A',
                    'anneeUniversitaire' => $detail->anneeUniversitaire ?? 'N/A',
                ] : [];

            case 'ConventionStage':
                $detail = $demande->conventionstage;
                return $detail ? [
                    'entreprise' => $detail->entreprise ?? 'N/A',
                    'periode' => ($detail->dateDebut && $detail->dateFin) ?
                        $detail->dateDebut->format('d/m/Y') . ' ‚Üí ' . $detail->dateFin->format('d/m/Y') : 'N/A',
                    'sujet' => $detail->sujet ?? 'N/A',
                ] : [];

            default:
                return [];
        }
    }

    /**
     * Mapper le type backend vers frontend
     */
    private function mapTypeToFrontend($type)
    {
        $mapping = [
            'AttestationScolarite' => 'attestation_scolarite',
            'AttestationReussite' => 'attestation_reussite',
            'ReleveNote' => 'releve_notes',
            'ConventionStage' => 'convention_stage'
        ];
        return $mapping[$type] ?? $type;
    }

    /**
     * Obtenir le label du type
     */
    private function getTypeLabel($type)
    {
        $labels = [
            'AttestationScolarite' => 'Attestation de scolarit√©',
            'AttestationReussite' => 'Attestation de r√©ussite',
            'ReleveNote' => 'Relev√© de notes',
            'ConventionStage' => 'Convention de stage'
        ];
        return $labels[$type] ?? $type;
    }

    /**
     * Pr√©visualiser une demande (g√©n√©rer HTML du document)
     */
    public function preview($idDemande)
    {
        try {
            $demande = Demande::with(['etudiant', 'administrateur'])->findOrFail($idDemande);

            $html = $this->generateDocumentHtml($demande);

            return response($html)
                ->header('Content-Type', 'text/html')
                ->header('Access-Control-Allow-Origin', '*')
                ->header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
                ->header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la g√©n√©ration du document: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * G√©n√©rer le HTML du document selon le type
     */
    private function generateDocumentHtml($demande)
    {
        $etudiant = $demande->etudiant;
        $type = $demande->typeDoc;

        $template = $this->getBaseTemplate();

        // Remplacer les donn√©es communes
        $template = str_replace('[NOM √âTUDIANT]', $etudiant->nom . ' ' . $etudiant->prenom, $template);
        $template = str_replace('[N¬∞ APOG√âE]', $etudiant->numApogee, $template);
        $template = str_replace('[CIN]', $etudiant->CIN ?? 'N/A', $template);
        $template = str_replace('[DATE NAISSANCE]', $etudiant->dateNaissance ? $etudiant->dateNaissance->format('d/m/Y') : 'N/A', $template);
        $template = str_replace('[LIEU NAISSANCE]', $etudiant->lieuNaissance ?? 'N/A', $template);
        $template = str_replace('[DATE ACTUELLE]', now()->format('d/m/Y'), $template);

        // Selon le type de document
        switch ($type) {
            case 'AttestationScolarite':
                $template = $this->generateAttestationScolarite($template, $demande);
                break;
            case 'AttestationReussite':
                $template = $this->generateAttestationReussite($template, $demande);
                break;
            case 'ConventionStage':
                $template = $this->generateConventionStage($template, $demande);
                break;
            case 'ReleveNote':
                $template = $this->generateReleveNotes($template, $demande);
                break;
        }

        return $template;
    }

    /**
     * Template de base HTML
     */
    private function getBaseTemplate()
    {
        return '<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Scolaire</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: white; padding: 20px; }
        .document { max-width: 800px; margin: 0 auto; padding: 40px; border: 2px solid #333; background: white; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #667eea; }
        .logo { font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .university-name { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .address { font-size: 12px; color: #666; }
        .doc-title { text-align: center; font-size: 24px; font-weight: bold; margin: 30px 0; text-decoration: underline; color: #333; }
        .content { line-height: 1.8; font-size: 14px; color: #333; }
        .content p { margin-bottom: 15px; }
        .field { display: inline-block; border-bottom: 1px solid #333; min-width: 200px; padding: 0 5px; }
        .signature-section { margin-top: 50px; display: flex; justify-content: space-between; }
        .signature-block { text-align: center; }
        .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 11px; color: #666; }
        .table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .table th, .table td { border: 1px solid #333; padding: 10px; text-align: left; }
        .table th { background: #667eea; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div class="document">
        <div class="header">
            <div class="logo">üéì UNIVERSIT√â</div>
            <div class="university-name">UNIVERSIT√â [NOM UNIVERSIT√â]</div>
            <div class="address">Adresse : [Adresse compl√®te]<br>T√©l : [T√©l√©phone] | Email : [Email]</div>
        </div>

        <div class="doc-title">[TITRE DOCUMENT]</div>

        <div class="content">
            [CONTENU]
        </div>

        <div class="signature-section">
            <div class="signature-block">
                <p>Fait √† [Ville]</p>
                <p>Le [DATE ACTUELLE]</p>
            </div>
            <div class="signature-block">
                <p><strong>Le Directeur</strong></p>
                <p style="margin-top: 50px;">Signature et Cachet</p>
            </div>
        </div>

        <div class="footer">
            Document g√©n√©r√© par le Service de Scolarit√©
        </div>
    </div>
</body>
</html>';
    }

    /**
     * G√©n√©rer Attestation de Scolarit√©
     */
    private function generateAttestationScolarite($template, $demande)
    {
        $etudiant = $demande->etudiant;
        $details = $demande->attestationscolarite;

        $titre = 'ATTESTATION DE SCOLARIT√â';
        $contenu = '
            <p><strong>Ann√©e universitaire :</strong> <span class="field">2024-2025</span></p>

            <p style="margin-top: 30px;">
                Je soussign√©(e), <span class="field">[Nom du Directeur]</span>,
                <strong>[Fonction]</strong> de l\'√©tablissement,
            </p>

            <p style="margin-top: 20px;">Certifie que :</p>

            <p style="margin-left: 30px;">
                <strong>Nom :</strong> <span class="field">' . $etudiant->nom . '</span><br>
                <strong>Pr√©nom :</strong> <span class="field">' . $etudiant->prenom . '</span><br>
                <strong>Date de naissance :</strong> <span class="field">[DATE NAISSANCE]</span><br>
                <strong>Lieu de naissance :</strong> <span class="field">[LIEU NAISSANCE]</span><br>
                <strong>N¬∞ Apog√©e :</strong> <span class="field">[N¬∞ APOG√âE]</span><br>
                <strong>CIN :</strong> <span class="field">[CIN]</span>
            </p>

            <p style="margin-top: 20px;">
                Est r√©guli√®rement inscrit(e) dans notre √©tablissement pour l\'ann√©e universitaire
                <strong>2024-2025</strong> en <span class="field">' . ($details ? $details->filiere : 'N/A') . '</span>.
            </p>

            <p style="margin-top: 30px;">
                La pr√©sente attestation est d√©livr√©e √† l\'int√©ress√©(e) pour servir et valoir ce que de droit.
            </p>
        ';

        $template = str_replace('[TITRE DOCUMENT]', $titre, $template);
        $template = str_replace('[CONTENU]', $contenu, $template);

        return $template;
    }

    /**
     * G√©n√©rer Attestation de R√©ussite
     */
    private function generateAttestationReussite($template, $demande)
    {
        $etudiant = $demande->etudiant;
        $details = $demande->attestationreussite;

        $titre = 'ATTESTATION DE R√âUSSITE';
        $contenu = '
            <p><strong>Ann√©e universitaire :</strong> <span class="field">' . ($details ? $details->anneeUniversitaire : '2023-2024') . '</span></p>

            <p style="margin-top: 30px;">
                Je soussign√©(e), <span class="field">[Nom du Directeur]</span>,
                <strong>[Fonction]</strong> de l\'√©tablissement,
            </p>

            <p style="margin-top: 20px;">Atteste que :</p>

            <p style="margin-left: 30px;">
                <strong>Nom :</strong> <span class="field">' . $etudiant->nom . '</span><br>
                <strong>Pr√©nom :</strong> <span class="field">' . $etudiant->prenom . '</span><br>
                <strong>Date de naissance :</strong> <span class="field">[DATE NAISSANCE]</span><br>
                <strong>Lieu de naissance :</strong> <span class="field">[LIEU NAISSANCE]</span><br>
                <strong>N¬∞ Apog√©e :</strong> <span class="field">[N¬∞ APOG√âE]</span><br>
                <strong>CIN :</strong> <span class="field">[CIN]</span>
            </p>

            <p style="margin-top: 20px;">
                A obtenu avec succ√®s son dipl√¥me de <strong><span class="field">' . ($details ? $details->filiere : 'N/A') . '</span></strong>
                au titre de l\'ann√©e universitaire <span class="field">' . ($details ? $details->anneeUniversitaire : 'N/A') . '</span>.
            </p>

            <p style="margin-top: 20px;">
                <strong>Mention :</strong> <span class="field">Bien</span>
            </p>

            <p style="margin-top: 30px;">
                La pr√©sente attestation est d√©livr√©e √† l\'int√©ress√©(e) pour servir et valoir ce que de droit,
                en attendant la d√©livrance du dipl√¥me d√©finitif.
            </p>
        ';

        $template = str_replace('[TITRE DOCUMENT]', $titre, $template);
        $template = str_replace('[CONTENU]', $contenu, $template);

        return $template;
    }

    /**
     * G√©n√©rer Convention de Stage
     */
    private function generateConventionStage($template, $demande)
    {
        $etudiant = $demande->etudiant;
        $details = $demande->conventionstage;

        $titre = 'CONVENTION DE STAGE';
        $contenu = '
            <p><strong>Entre les soussign√©s :</strong></p>

            <p style="margin-top: 20px;"><strong>L\'UNIVERSIT√â :</strong></p>
            <p style="margin-left: 30px;">
                Repr√©sent√©e par <span class="field">[Nom du Directeur]</span>, en sa qualit√© de Directeur
            </p>

            <p style="margin-top: 20px;"><strong>ET L\'ENTREPRISE :</strong></p>
            <p style="margin-left: 30px;">
                <strong>Raison sociale :</strong> <span class="field">' . ($details ? $details->entreprise : 'N/A') . '</span><br>
                <strong>Secteur d\'activit√© :</strong> <span class="field">N/A</span><br>
                <strong>Adresse :</strong> <span class="field">N/A</span><br>
                <strong>Ville :</strong> <span class="field">N/A</span><br>
                <strong>T√©l√©phone :</strong> <span class="field">N/A</span><br>
                <strong>Email :</strong> <span class="field">N/A</span><br>
                Repr√©sent√©e par <span class="field">N/A</span>,
                <span class="field">N/A</span>
            </p>

            <p style="margin-top: 20px;"><strong>CONCERNANT LE STAGIAIRE :</strong></p>
            <p style="margin-left: 30px;">
                <strong>Nom et Pr√©nom :</strong> <span class="field">[NOM √âTUDIANT]</span><br>
                <strong>N¬∞ Apog√©e :</strong> <span class="field">[N¬∞ APOG√âE]</span><br>
                <strong>Fili√®re :</strong> <span class="field">N/A</span><br>
                <strong>Niveau :</strong> <span class="field">N/A</span>
            </p>

            <p style="margin-top: 20px;"><strong>OBJET DU STAGE :</strong></p>
            <p style="margin-left: 30px;">
                <strong>Type de stage :</strong> <span class="field">N/A</span><br>
                <strong>Sujet :</strong> <span class="field">' . ($details ? $details->sujet : 'N/A') . '</span><br>
                <strong>P√©riode :</strong> Du <span class="field">' . ($details && $details->dateDebut ? $details->dateDebut->format('d/m/Y') : 'N/A') . '</span>
                au <span class="field">' . ($details && $details->dateFin ? $details->dateFin->format('d/m/Y') : 'N/A') . '</span>
            </p>

            <p style="margin-top: 20px;"><strong>ENCADREMENT :</strong></p>
            <p style="margin-left: 30px;">
                <strong>Encadrant acad√©mique :</strong> <span class="field">N/A</span><br>
                <strong>Encadrant entreprise :</strong> <span class="field">N/A</span><br>
                <strong>Fonction :</strong> <span class="field">N/A</span><br>
                <strong>T√©l√©phone :</strong> <span class="field">N/A</span><br>
                <strong>Email :</strong> <span class="field">N/A</span>
            </p>

            <p style="margin-top: 30px;">
                <strong>Article 1 :</strong> Le stagiaire s\'engage √† respecter le r√®glement int√©rieur
                de l\'entreprise et √† se conformer aux directives qui lui seront donn√©es.
            </p>

            <p style="margin-top: 10px;">
                <strong>Article 2 :</strong> L\'entreprise s\'engage √† encadrer le stagiaire et √† lui fournir
                les moyens n√©cessaires √† l\'accomplissement de sa mission.
            </p>
        ';

        $template = str_replace('[TITRE DOCUMENT]', $titre, $template);
        $template = str_replace('[CONTENU]', $contenu, $template);

        // Modifier la section signature pour 3 signatures
        $signatureSection = '
        <div class="signature-section">
            <div class="signature-block">
                <p><strong>Le Directeur</strong></p>
                <p style="margin-top: 50px;">Signature et Cachet</p>
            </div>
            <div class="signature-block">
                <p><strong>Le Repr√©sentant</strong></p>
                <p><strong>de l\'Entreprise</strong></p>
                <p style="margin-top: 30px;">Signature et Cachet</p>
            </div>
            <div class="signature-block">
                <p><strong>Le Stagiaire</strong></p>
                <p style="margin-top: 50px;">Signature</p>
            </div>
        </div>
        ';

        $template = str_replace('<div class="signature-section">
            <div class="signature-block">
                <p>Fait √† [Ville]</p>
                <p>Le [DATE ACTUELLE]</p>
            </div>
            <div class="signature-block">
                <p><strong>Le Directeur</strong></p>
                <p style="margin-top: 50px;">Signature et Cachet</p>
            </div>
        </div>', $signatureSection, $template);

        return $template;
    }

    /**
     * G√©n√©rer Relev√© de Notes
     */
    private function generateReleveNotes($template, $demande)
    {
        $etudiant = $demande->etudiant;
        $details = $demande->relevenote;

        $titre = 'RELEV√â DE NOTES';
        $contenu = '
            <p>
                <strong>Ann√©e universitaire :</strong> <span class="field">' . ($details ? $details->anneeUniversitaire : '2023-2024') . '</span> |
                <strong>Semestre :</strong> <span class="field">' . ($details ? $details->semestre : 'S6') . '</span>
            </p>

            <p style="margin-top: 20px;">
                <strong>Nom :</strong> <span class="field">' . $etudiant->nom . '</span><br>
                <strong>Pr√©nom :</strong> <span class="field">' . $etudiant->prenom . '</span><br>
                <strong>N¬∞ Apog√©e :</strong> <span class="field">[N¬∞ APOG√âE]</span><br>
                <strong>CIN :</strong> <span class="field">[CIN]</span><br>
                <strong>Fili√®re :</strong> <span class="field">N/A</span><br>
                <strong>Niveau :</strong> <span class="field">N/A</span>
            </p>

            <table class="table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Module</th>
                        <th>Note</th>
                        <th>R√©sultat</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>INFO101</td>
                        <td>Programmation C</td>
                        <td>15.50</td>
                        <td>Valid√©</td>
                    </tr>
                    <tr>
                        <td>INFO102</td>
                        <td>Algorithmes et Structures de Donn√©es</td>
                        <td>14.00</td>
                        <td>Valid√©</td>
                    </tr>
                    <tr>
                        <td>INFO201</td>
                        <td>Bases de Donn√©es</td>
                        <td>16.25</td>
                        <td>Valid√©</td>
                    </tr>
                    <tr>
                        <td>MATH101</td>
                        <td>Analyse Math√©matique</td>
                        <td>13.75</td>
                        <td>Valid√©</td>
                    </tr>
                    <tr>
                        <td>MATH102</td>
                        <td>Alg√®bre Lin√©aire</td>
                        <td>12.50</td>
                        <td>Valid√©</td>
                    </tr>
                    <tr>
                        <td>LANG101</td>
                        <td>Anglais Scientifique</td>
                        <td>15.00</td>
                        <td>Valid√©</td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right;"><strong>Moyenne G√©n√©rale :</strong></td>
                        <td colspan="2"><strong>14.50 / 20</strong></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right;"><strong>R√©sultat :</strong></td>
                        <td colspan="2"><strong>Admis(e)</strong></td>
                    </tr>
                </tbody>
            </table>

            <p style="margin-top: 20px;">
                <strong>Mention :</strong> <span class="field">Bien</span>
            </p>

            <p style="margin-top: 30px; font-size: 12px;">
                <strong>L√©gende :</strong> Moyenne ‚â• 10 : Valid√© | Moyenne < 10 : Non valid√©
            </p>
        ';

        $template = str_replace('[TITRE DOCUMENT]', $titre, $template);
        $template = str_replace('[CONTENU]', $contenu, $template);

        return $template;
    }
}